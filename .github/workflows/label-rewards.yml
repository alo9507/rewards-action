name: Octobay Rewards
on:
  issues:
    types: [labeled]

env:
  ISSUE_AUTHOR: ${{ github.event.issue.user.login }}

jobs:
  user-config:
    # only allow mktcode to trigger rewards by labeling issues
    if: ${{ github.event.sender.login == 'mktcode' }}
    runs-on: ubuntu-latest
    outputs:
      address: ${{ steps.user-config.outputs.address }}
    steps:
      - name: Get config for ${{ env.ISSUE_AUTHOR }}
        uses: octobay/get-user-config-action@v1
        id: user-config
        with:
          username: ${{ env.ISSUE_AUTHOR }}
          access-token: ${{ secrets.GITHUB_TOKEN }}

  reward:
    runs-on: ubuntu-latest
    needs: [ user-config ]
    steps:
    - uses: actions/checkout@v1
    - name: Send reward
      uses: octobay/rewards-action@v1
      if: ${{ needs.user-config.outputs.address }}
      with:
        to-address: ${{ needs.user-config.outputs.address }}
        seed-phrase: '${{ secrets.WALLET_SEED_PHRASE }}'
        rpc-node: ${{ secrets.RPC_NODE }}
    - if: ${{ !needs.user-config.outputs.address }}
      run: echo "::warning::User has a config file (.octobay.json) but no valid address configured."
  
  # add message when label was set by someone other then mktcode
  skip:
    if: ${{ github.event.sender.login != 'mktcode' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "::warning::Only mktcode can trigger rewards by labeling issues."
